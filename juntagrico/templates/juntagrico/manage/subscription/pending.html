{% extends "../base.html" %}
{% load i18n %}
{% load juntagrico.config %}
{% load juntagrico.common %}
{% load juntagrico.snippets %}
{% block page_title %}
    <h3>
        {% vocabulary "subscription_pl" as v_subscription_pl %}
        {% blocktrans %}Pendente Änderungen an {{ v_subscription_pl }}{% endblocktrans %}
    </h3>
{% endblock %}
{% block content %}
    <div class="alert alert-danger">{% trans "Diese Ansicht ist noch experimentell." %}</div>
    {% action_date request %}
    {% has_extra_subscriptions as b_has_extra_subscriptions %}
    {% if b_has_extra_subscriptions %}
        <div>
            <span class="switch switch-sm">
                <input class="switch" type="checkbox" id="show_extras">
                <label for="show_extras">{% trans "Zusatz-Abos anzeigen" %}</label>
            </span>
        </div>
    {% endif %}
    {{ block.super }}
{% endblock %}
{% block list %}
    {% config "enable_shares" as enable_shares %}
    {% vocabulary "subscription" as v_subscription %}
    <table id="filter-table" class="list table">
        <thead>
            <tr>
                <th class="filter">
                    {% vocabulary "subscription" %}
                </th>
                <th class="filter">
                    {% trans "Gekündigt" %}
                </th>
                <th class="filter">
                    {% trans "Bestellt" %}
                </th>
                <th class="filter">
                    {% trans "Kontakt" %}
                </th>
                {% if enable_shares %}
                    <th class="filter">
                        {% trans "Bezahlte Anteilsscheine" %}
                    </th>
                {% endif %}
                <th class="filter">
                    {% trans "Aktionen" %}
                </th>
                <th>
                    {% trans "Notizen" %}
                </th>
            </tr>
        </thead>
        <tbody>
            {% for subscription in object_list %}
                {% with cancelled_parts=subscription.parts.cancelled ordered_parts=subscription.parts.ordered %}
                {% with has_normal_cancelled_parts=cancelled_parts.is_normal.exists has_normal_ordered_parts=ordered_parts.is_normal.exists %}
                    <tr class="{% if not has_normal_cancelled_parts and not has_normal_ordered_parts %}show-extra{% endif %}">
                        <td>
                            <a href="{% url 'admin:juntagrico_subscription_change' subscription.id %}">
                                {{ subscription.id }}
                            </a>
                        </td>
                        <td class="pl-5">
                            {# TODO: Don't show checkboxes, if entire sub is cancelled. Or add option to deactivate selectively #}
                            {% regroup cancelled_parts by cancellation_date as parts_by_date %}
                            {% include "./snippets/parts_by_date.html" %}
                            {% if parts_by_date and subscription.cancellation_date %}
                                <div class="end-date pre">Auf: {{ subscription.end_date|date:"Y-m-d"|default:"?" }}</div>
                            {% endif %}
                        </td>
                        <td class="pl-5">
                            {% regroup ordered_parts by creation_date as parts_by_date %}
                            {% include "./snippets/parts_by_date.html" %}
                            {% if parts_by_date and not subscription.activation_date %}
                                <div class="start-date pre">Auf: {{ subscription.start_date|date:"Y-m-d"|default:"?" }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% with member=subscription.primary_member %}
                                {# TODO: only link if has permission to view or change member #}
                                <a href="{% url 'admin:juntagrico_member_change' member.id %}">
                                    {{ member }}
                                </a>
                                <div>
                                    <a href="{% url "email-to-member" member.id %}" class="email">
                                        {{ member.email }}
                                    </a>
                                </div>
                            {% endwith %}
                        </td>
                        {% if enable_shares %}
                            <td>
                                {{ subscription.paid_shares }}
                                {% if subscription.paid_shares %}
                                    {% trans "(J)" %}
                                {% else %}
                                    {% trans "(N)" %}
                                {% endif %}
                            </td>
                        {% endif %}
                        <td>
                            {# TODO: Subscription activation is not yet selective. All parts will be activated. #}
                            {% if not subscription.activation_date %}
                                <a href="{% url 'sub-activate' subscription.id %}" class="btn btn-success mb-1">
                                    {% blocktrans %}{{ v_subscription }} aktivieren{% endblocktrans %}
                                </a>
                                {% if subscription.cancellation_date and not subscription.deactivation_date %}
                                    <a href="{% url 'sub-deactivate' subscription.id %}" class="btn btn-danger mb-1">
                                        {% blocktrans %}{{ v_subscription }} stornieren{% endblocktrans %}
                                    </a>
                                {% endif %}
                            {% elif subscription.cancellation_date and not subscription.deactivation_date %}
                                <a href="{% url 'sub-deactivate' subscription.id %}" class="btn btn-danger mb-1">
                                    {% blocktrans %}{{ v_subscription }} deaktivieren{% endblocktrans %}
                                </a>
                            {% else %}
                                <form method="post" id="form-sub-{{ subscription.id }}">
                                    {% csrf_token %}
                                    {% if ordered_parts and cancelled_parts %}
                                        <button formaction="{% url 'parts-apply' %}" type="submit"
                                                class="btn btn-warning mb-1{% if not has_normal_ordered_parts or not has_normal_cancelled_parts %} show-extra{% endif %}">
                                            {% trans "Bestandteil(e) ändern" %}
                                        </button>
                                    {% endif %}
                                    {% if ordered_parts %}
                                        <button formaction="{% url 'parts-activate' %}" type="submit"
                                                class="btn btn-success mb-1{% if not has_normal_ordered_parts %} show-extra{% endif %}">
                                            {% trans "Bestandteil(e) aktivieren" %}
                                        </button>
                                    {% endif %}
                                    {% if cancelled_parts %}
                                        <button formaction="{% url 'parts-deactivate' %}" type="submit"
                                                class="btn btn-danger mb-1{% if not has_normal_cancelled_parts %} show-extra{% endif %}">
                                            {% trans "Bestandteil(e) deaktivieren" %}
                                        </button>
                                    {% endif %}
                                </form>
                            {% endif %}
                        </td>
                        <td>
                            {{ subscription.notes }}
                        </td>
                    </tr>
                {% endwith %}
                {% endwith %}
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script type="text/javascript">
        function redraw_on_show_extra () {
            // this makes the buttons show up correctly taking show-extra status into account
            $('#filter-table').DataTable().draw()
        }

        $(function(){
            $('.parts-for-date:not(:has(.show-normal))').addClass('show-extra')  // makes date also hide if only has extras
            $("#show_extras").ToggleButton('.show-extra', redraw_on_show_extra)
            redraw_on_show_extra()
            
            // prevent selection of row when clicking checkbox
            $("input, label").click(function(e) {e.stopPropagation()})
        })
    </script>
{% endblock %}
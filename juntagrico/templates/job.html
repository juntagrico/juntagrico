{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load juntagrico.common %}
{% load juntagrico.config %}
{% load static %}

{% block page_title %}
    <h3>
        {{ job.type.get_name }}
    </h3>
{% endblock %}

{% block messages %}
    {% if error %}
        {% include "messages/error.html" %}
    {% endif %}
    {% if form.current_assignments.count %}
        {% include "messages/job_assigned.html" with others=form.current_assignments.count|add:"-1" %}
    {% elif job.canceled %}
        {% include "messages/job_canceled.html" %}
    {% elif job.has_ended %}
        {% include "messages/job_past.html" %}
    {% elif job.has_started %}
        {% include "messages/job_running.html" %}
    {% elif job.free_slots == 0 %}
        {% include "messages/job_fully_booked.html" %}
    {% endif %}
{% endblock %}

{% block content %}
    {% vocabulary "assignment_pl" as v_assignment_pl %}
    {% block admin_actions %}
        {% if edit_url.strip or can_copy or can_cancel %}
            <div class="row pb-4">
                <div class="col-md-12">
                    {% if edit_url.strip %}
                        <a href="{{ edit_url }}" class="btn btn-primary">
                            <i class="fas fa-pen mr-1"></i>
                            {% trans "Einsatz bearbeiten" %}
                        </a>
                    {% endif %}

                    {% if can_copy %}
                        {% if is_recurring %}
                            <div class="btn-group">
                                <a href="{% url 'admin:action-copy-job' job.id %}" type="button" class="btn btn-outline-primary">
                                    <i class="fa-solid fa-copy"></i>
                                    {% trans "Einsatz kopieren" %}
                                </a>
                                <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split"
                                        data-toggle="dropdown" data-reference="parent" aria-expanded="false">
                                    <span class="sr-only">{% trans "Dropdown √∂ffnen" %}</span>
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="{% url 'admin:action-mass-copy-job' job.id %}">
                                        {% trans "Mehrfach kopieren" %}
                                    </a>
                                </div>
                            </div>
                        {% else %}
                            <a href="{% url 'admin:action-copy-onetime-job' job.id %}" class="btn btn-outline-primary">
                                <i class="fa-solid fa-copy"></i>
                                {% trans "Einsatz kopieren" %}
                            </a>
                        {% endif %}
                    {% endif %}

                    {% if can_convert %}
                        {% if is_recurring %}
                            <form action="{% url 'job-convert-to-one-time' %}" method="POST" class="d-inline"
                                  onsubmit="return confirm('{% trans "Bist du sicher, dass du diesen Einsatz in einen einmaligen Einsatz umwandeln m√∂chtest?" %}')">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-primary" name="job_id" value="{{ job.id }}"
                                        title="{% trans "in einmaligen Einsatz umwandeln" %}">
                                    <i class="fa-solid fa-repeat"></i>
                                    {% trans "Umwandeln" %}
                                </button>
                            </form>
                        {% else %}
                            <a class="convert-to-recurring-job btn btn-outline-primary"
                               title="{% trans "in wiederkehrenden Einsatz umwandeln" %}"
                               data-url="{% url 'job-convert-to-recurring' job.id %}">
                                <i class="fa-solid fa-repeat"></i>
                                {% trans "Umwandeln" %}
                            </a>
                        {% endif %}
                    {% endif %}

                    {% if can_cancel %}
                        <form action="{% url 'job-cancel' %}" method="POST" class="d-inline"
                              onsubmit="return confirm('{% trans "Bist du sicher, dass du diesen Einsatz absagen m√∂chtest?" %}')">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger" name="job_id" value="{{ job.id }}">
                                <i class="fas fa-ban mr-1"></i>
                                {% trans "Einsatz absagen" %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {# Modals #}
        {% if convertion_form %}
            {% include "juntagrico/job/modals/convert_to_recurring.html" with name='convert_to_recurring_job' %}
        {% endif %}
    {% endblock %}

    {% block time %}
        <div class="row pb-4">
            <div class="col-md-3">
                {% trans "Zeitpunkt" %}:
            </div>
            <div class="col-md-5">
                {{ job.time |date:"l, d.m.Y, H:i" }} - {{ job.end_time|date:"H:i" }}
                <br/>
                {% if job_is_in_past %}
                    (vor {{ job.end_time|timesince }})
                {% elif job_is_running %}
                    (seit {{ job.time|timesince }})
                {% else %}
                    (in {{ job.time|timeuntil }})
                {% endif %}
            </div>
        </div>
    {% endblock %}

    {% if not job.infinite_slots %}
        {% block status %}
            <div class="row pb-4">
                <div class="col-md-3">
                    {% trans "Status" %}:
                </div>
                {% with slots_taken=job.occupied_slots %}
                    <div class="col-md-5" title="{{ slots_taken }} von {{ job.slots }} gebucht">
                        {% spaceless %}
                            {% for _ in ''|ljust:job.slots %}
                                {% if forloop.counter <= slots_taken %}
                                    <img src="{% images "single_full" %}" alt="{% trans "Belegter Platz" %}"/>
                                {% else %}
                                    <img src="{% images "single_empty" %}" alt="{% trans "Freier Platz" %}"/>
                                {% endif %}
                            {% endfor %}
                        {% endspaceless %}
                    </div>
                {% endwith %}
            </div>
        {% endblock %}
    {% endif %}

    {% block multiplier %}
        {% if job.multiplier == 0 %}
            <div class="row pb-4">
                <div class="col-md-3">
                    {% vocabulary "assignment_pl" %}:
                </div>
                <div class="col-md-5">
                    {% blocktrans trimmed with jm=job.multiplier %}
                    Du erh√§ltst f√ºr diese Veranstaltung keine {{ v_assignment_pl }} gutgeschrieben.
                    {% endblocktrans %}
                </div>
            </div>
        {% elif job.multiplier != 1 %}
            <div class="row pb-4">
                <div class="col-md-3">
                    {% vocabulary "assignment_pl" %}:
                </div>
                <div class="col-md-5">
                    {% blocktrans trimmed with jm=job.multiplier %}
                    Du erh√§ltst f√ºr diesen Einsatz das {{ jm }}-Fache an {{ v_assignment_pl }} gutgeschrieben.
                    {% endblocktrans %}
                </div>
            </div>
        {% endif %}
    {% endblock %}

    {% if job.extras.strip %}
        {% block extras %}
            <div class="row pb-4">
                <div class="col-md-3">
                    {% trans "Extras" %}:
                </div>
                <div class="col-md-5">
                    {% for extra in job.empty_per_job_extras %}
                        {{ extra.extra_type.display_empty|safe }}
                    {% endfor %}
                    {% for extra in job.full_per_job_extras %}
                        {{ extra.extra_type.display_full|safe }}
                    {% endfor %}
                </div>
            </div>
        {% endblock %}
    {% endif %}

    {% block location %}
        <div class="row pb-4">
            <div class="col-md-3">
                {% trans "Ort" %}:
            </div>
            <div class="col-md-5" id="map-container">
                {{ job.type.location.to_html|safe }}
                {% if job.type.location.google_maps_query %}
                    <br>
                    {% if job.type.location.has_coordinates %}
                        <a class="open-map" href="#">{% trans "Karte" %}</a> -
                    {% endif %}
                    <a href="https://www.google.com/maps/dir/?api=1&destination={{ job.type.location.google_maps_query | urlencode }}" target="_blank">
                        {% trans "Wegbeschreibung" %}
                    </a>
                {% endif %}
            </div>
        </div>
    {% endblock %}

    {% block description %}
        <div class="row pb-4">
            <div class="col-md-3">
                {% trans "Beschreibung" %}:
            </div>
            <div class="col-md-5">
                <div class="job-description">{{ job.type.description|richtext|safe }}</div>
                {% if job.additional_description %}
                    <div class="job-additional-description">{{ job.additional_description|richtext|safe }}</div>
                {% endif %}
            </div>
        </div>
    {% endblock %}

    {% block contact %}
        <div class="row pb-4">
            <div class="col-md-3">
                {% trans "Kontakt" %}:
            </div>
            <div class="col-md-5">
                {% for contact in job.contacts %}
                    {{ contact.to_html }}
                {% endfor %}
            </div>
        </div>
    {% endblock %}

    {% block participants %}
        <div class="row pb-4">
            <div class="col-md-3">
                {% trans "Dabei sind" %}:
            </div>
            <div class="col-md-5">
                {% if job.occupied_slots == 0 and job.free_slots != 0 %}
                    {% trans "Noch niemand" %} ü•∫
                {% else %}
                    {% include "juntagrico/job/snippets/participant_list.html" %}
                {% endif %}
            </div>
        </div>
    {% endblock %}

    {% block subscribe %}
        {% if form.can_interact %}
            {% crispy form %}
        {% endif %}
    {% endblock %}
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'juntagrico/external/leaflet/leaflet.css' %}" />
{% endblock %}

{% block scripts %}
    {{ job.type.location.map_info|json_script:'location_data' }}
    {% include 'snippets/scripts/leaflet.html' %}
    <script type="text/javascript" src="{% static 'juntagrico/js/initJob.js' %}">
    </script>
{% endblock %}
